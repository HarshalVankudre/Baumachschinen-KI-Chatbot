# Promtail Configuration
# Building Machinery AI Chatbot
#
# Promtail collects logs from Docker containers and ships them to Loki.
# It scrapes logs from Docker container JSON log files.
#
# Last Updated: 2025-11-02

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # ===========================================================================
  # Docker Container Logs
  # ===========================================================================
  - job_name: docker_containers
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      # Extract container name
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container_name'

      # Extract container ID
      - source_labels: ['__meta_docker_container_id']
        target_label: 'container_id'

      # Extract image name
      - source_labels: ['__meta_docker_container_image']
        target_label: 'image'

      # Extract log path
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: 'stream'

    # Parse JSON logs
    pipeline_stages:
      - json:
          expressions:
            output: log
            stream: stream
            timestamp: time

      # Parse timestamp
      - timestamp:
          source: timestamp
          format: RFC3339Nano

      # Extract log level from log message
      - regex:
          expression: '(?P<level>DEBUG|INFO|WARNING|ERROR|CRITICAL)'

      # Add labels
      - labels:
          level:
          stream:

  # ===========================================================================
  # System Logs (Optional)
  # ===========================================================================
  - job_name: system_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: systemlogs
          __path__: /var/log/*.log

# =============================================================================
# Promtail Features
# =============================================================================
#
# Log Collection:
#   - Automatically discovers Docker containers
#   - Reads container JSON logs
#   - Extracts structured metadata
#   - Sends to Loki for storage
#
# Log Enrichment:
#   - Container name, ID, image
#   - Log level extraction
#   - Timestamp parsing
#   - Custom labels
#
# Performance:
#   - Position tracking (resumes from last position)
#   - Batch processing
#   - Compression
#
# =============================================================================
