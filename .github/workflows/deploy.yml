# GitHub Actions CI/CD Pipeline
# Building Machinery AI Chatbot
#
# This workflow provides comprehensive CI/CD:
# 1. Automated testing (backend and frontend)
# 2. Code quality checks (linting, formatting)
# 3. Security scanning
# 4. Docker image building and pushing to GHCR
# 5. Zero-downtime deployment to Digital Ocean
# 6. Health checks and automatic rollback on failure
# 7. Deployment notifications
#
# Triggers:
# - Push to main branch: Full CI/CD pipeline
# - Pull requests: Testing and validation only
#
# Last Updated: 2025-11-02

name: Build, Test, and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual triggers

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===========================================================================
  # TEST JOB - Run all tests and quality checks
  # ===========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------------------------------------------------------------------
      # Backend Testing
      # ---------------------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install backend dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov httpx black flake8

      - name: Run backend linting (Black)
        run: |
          cd backend
          black --check . || echo "Black formatting issues found"

      - name: Run backend linting (Flake8)
        run: |
          cd backend
          flake8 app --max-line-length=120 --extend-ignore=E203,W503 || echo "Flake8 issues found"

      - name: Run backend unit tests
        run: |
          cd backend
          pytest tests/ -v --cov=app --cov-report=xml --cov-report=term
        env:
          ENVIRONMENT: test
          MONGODB_URI: ${{ secrets.MONGODB_URI_TEST }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Upload backend coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage.xml
          flags: backend
          name: backend-coverage

      # ---------------------------------------------------------------------
      # Frontend Testing
      # ---------------------------------------------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Run frontend linting
        run: |
          cd frontend
          npm run lint || echo "Linting issues found"

      - name: Run frontend tests
        run: |
          cd frontend
          npm run test -- --coverage --watchAll=false

      - name: Upload frontend coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./frontend/coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage

      # ---------------------------------------------------------------------
      # Security Scanning
      # ---------------------------------------------------------------------
      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ===========================================================================
  # BUILD JOB - Build and push Docker images
  # ===========================================================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ---------------------------------------------------------------------
      # Build Backend Image
      # ---------------------------------------------------------------------
      - name: Extract backend metadata
        id: backend-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/backend
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.backend-meta.outputs.tags }}
          labels: ${{ steps.backend-meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: Scan backend image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/backend:latest
          format: 'sarif'
          output: 'trivy-backend-results.sarif'

      # ---------------------------------------------------------------------
      # Build Frontend Image
      # ---------------------------------------------------------------------
      - name: Extract frontend metadata
        id: frontend-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/frontend
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.frontend-meta.outputs.tags }}
          labels: ${{ steps.frontend-meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            REACT_APP_VERSION=${{ github.sha }}

      - name: Scan frontend image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:latest
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'

  # ===========================================================================
  # DEPLOY JOB - Deploy to production server
  # ===========================================================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    environment:
      name: production
      url: https://chatbot.yourcompany.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Digital Ocean via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_SSH_PORT || 22 }}
          script_stop: true
          script: |
            set -e

            echo "=========================================="
            echo "Starting deployment process..."
            echo "Timestamp: $(date)"
            echo "Commit: ${{ github.sha }}"
            echo "=========================================="

            # Navigate to application directory
            cd /opt/chatbot

            # Authenticate with GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Create pre-deployment backup
            if [ -x "./scripts/backup.sh" ]; then
              echo "Creating backup..."
              ./scripts/backup.sh || echo "Backup failed, continuing..."
            fi

            # Pull latest images
            echo "Pulling latest Docker images..."
            docker compose -f docker-compose.production.yml pull

            # Deploy with zero-downtime rolling update
            echo "Deploying backend..."
            docker compose -f docker-compose.production.yml up -d --no-deps --force-recreate backend

            echo "Waiting for backend to be healthy..."
            sleep 20

            # Check backend health
            for i in {1..5}; do
              if curl -f -s http://localhost:8000/api/health > /dev/null; then
                echo "Backend is healthy"
                break
              fi
              if [ $i -eq 5 ]; then
                echo "Backend health check failed"
                docker compose -f docker-compose.production.yml logs backend
                exit 1
              fi
              echo "Waiting for backend... (attempt $i/5)"
              sleep 10
            done

            # Deploy frontend
            echo "Deploying frontend..."
            docker compose -f docker-compose.production.yml up -d --no-deps --force-recreate frontend

            echo "Waiting for frontend to be healthy..."
            sleep 10

            # Update monitoring services (non-critical)
            echo "Updating monitoring services..."
            docker compose -f docker-compose.production.yml up -d prometheus grafana loki promtail node-exporter || echo "Monitoring update failed (non-critical)"

            # Run comprehensive health check
            echo "Running health checks..."
            if [ -x "./scripts/health_check.sh" ]; then
              ./scripts/health_check.sh || {
                echo "Health check failed! Rolling back..."
                docker compose -f docker-compose.production.yml down
                docker compose -f docker-compose.production.yml up -d
                exit 1
              }
            else
              # Basic health checks
              if ! curl -f -s http://localhost:8000/api/health > /dev/null; then
                echo "Backend health check failed!"
                exit 1
              fi
              if ! curl -f -s http://localhost:3000 > /dev/null; then
                echo "Frontend health check failed!"
                exit 1
              fi
              echo "Basic health checks passed"
            fi

            # Clean up old images
            echo "Cleaning up old Docker images..."
            docker image prune -f

            echo "=========================================="
            echo "Deployment completed successfully!"
            echo "=========================================="

            # Display running containers
            docker compose -f docker-compose.production.yml ps

      # ---------------------------------------------------------------------
      # Post-Deployment Actions
      # ---------------------------------------------------------------------
      - name: Create deployment record
        if: success()
        run: |
          echo "Deployment successful at $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Deployed by: ${{ github.actor }}"

      - name: Notify on deployment success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              target_url: 'https://chatbot.yourcompany.com',
              description: 'Deployment successful',
              context: 'deployment/production'
            })

      - name: Notify on deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'failure',
              description: 'Deployment failed',
              context: 'deployment/production'
            })

      # Optional: Send Slack notification
      # - name: Notify Slack
      #   if: always()
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: 'Deployment to production ${{ job.status }}'
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}

# =============================================================================
# Required GitHub Secrets
# =============================================================================
#
# Repository Secrets (Settings -> Secrets and variables -> Actions):
#
# Docker Registry:
#   - GITHUB_TOKEN (automatically provided)
#
# Digital Ocean:
#   - DO_HOST: Droplet IP address (e.g., 143.198.123.456)
#   - DO_USERNAME: SSH username (e.g., deploy)
#   - DO_SSH_KEY: Private SSH key for authentication
#   - DO_SSH_PORT: SSH port (optional, default: 22)
#
# Testing:
#   - MONGODB_URI_TEST: MongoDB URI for testing
#   - OPENAI_API_KEY: OpenAI API key for tests
#
# Notifications (Optional):
#   - SLACK_WEBHOOK: Slack webhook URL for notifications
#
# =============================================================================
# Workflow Features
# =============================================================================
#
# Testing:
#   - Backend: pytest with coverage
#   - Frontend: Jest/Vitest with coverage
#   - Linting: Black, Flake8, ESLint
#   - Security scanning: Trivy
#
# Building:
#   - Multi-stage Docker builds
#   - Layer caching for faster builds
#   - Image tagging: latest, SHA, branch
#   - Vulnerability scanning
#
# Deployment:
#   - Zero-downtime rolling updates
#   - Pre-deployment backup
#   - Health checks with retries
#   - Automatic rollback on failure
#   - Post-deployment verification
#
# Notifications:
#   - GitHub commit status
#   - Optional Slack integration
#
# =============================================================================
